<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="calibTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:fc="http://java.sun.com/jsf/composite/comps"
                xmlns:h="http://java.sun.com/jsf/html" >

    <ui:define name="content">
        <h:form id="equipForm"> 
            <p:growl id="equipMsgs" showDetail="true"/> 
            <p:dataTable id="equipTable" var="equipment" value="#{equipmentManager.equipments}" 
                         paginator="true" rows="20" resizableColumns="true"                                   
                         rowKey="#{equipment.serialNumber}"                        
                         emptyMessage="No Equipment Found."
                         selection="#{equipmentManager.selectedEquip}" 
                         filteredValue="#{equipmentManager.filteredEquipments}" 
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"  
                         rowsPerPageTemplate="25,50,100"   >
                <f:facet name="header">
                    <h:outputText value="Equipment" />                       
                </f:facet>
                <p:column style="width:3%">  
                    <p:rowToggler />  
                </p:column> 

                <p:column id="model" headerText="Model" sortBy="#{equipment.manufModel}"
                          filterBy="#{equipment.manufModel}"
                          filterMatchMode="startsWith"  >                  
                    <h:outputText value="#{equipment.manufModel}" />                                    
                </p:column> 
                <p:column id="serial" headerText="Serial" sortBy="#{equipment.serialNumber}"
                          filterBy="#{equipment.serialNumber}"
                          filterMatchMode="contains" style="width: 20%"
                          rendered="false">
                    <h:outputText value="#{equipment.serialNumber}" /> 

                </p:column>
                <p:column id="manufsn" headerText="Serial #" 
                          filterBy="#{equipment.manufSerialNumber}"
                          filterMatchMode="contains" >                  
                    <h:outputText value="#{equipment.manufSerialNumber}" />                              
                </p:column>
                <p:column id="manuf" headerText="Manufacturer" 
                          filterBy="#{equipment.manufacturer}"
                          filterMatchMode="contains" >                  
                    <h:outputText value="#{equipment.manufacturer}" />                              
                </p:column>         
                <p:column id="desc" headerText="Description" style="width: 30%"
                          filterBy="#{equipment.description}"
                          filterMatchMode="contains" >                  
                    <h:outputText value="#{equipment.description}" />                              
                </p:column>

                <p:column id="servdate" headerText="Last Serviced" 
                          sortBy="#{equipment.dateLastServiced}" >                  
                    <h:outputText value="#{equipment.dateLastServiced}" > 
                        <f:convertDateTime pattern="yyyy-MM-dd" />
                    </h:outputText>
                </p:column>
                <p:column id="location" headerText="Location" >                  
                    <h:outputText value="#{equipment.location}" />                              
                </p:column>
                <p:column id="custodian" headerText="Custodian" >                  
                    <h:outputText value="#{equipment.custodian}" />                              
                </p:column>
                <p:column id="cstandard" headerText="Std" 
                          sortBy="#{equipment.calibStandard}"  >                  
                    <h:outputText styleClass="ui-icon ui-icon-check" rendered="#{equipment.calibStandard}" />                              
                </p:column>
                <p:column id="active" headerText="Active" 
                          sortBy="#{equipment.active}"  >                  
                    <h:outputText styleClass="ui-icon ui-icon-check" rendered="#{equipment.active}" />                              
                </p:column>
                <p:rowExpansion>  
                    <p:dataTable id="calibRecs" var="calibrec" value="#{equipment.calibrationRecordList}" 
                                 emptyMessage="No Calibration Records Found."  transient="true">
                        <f:facet name="header">                            
                            <h:outputText value="Calibration Records" /> 
                        </f:facet>
                        <p:column id="crdate" headerText="Date">                  
                            <h:outputText value="#{calibrec.calibrationDate}" >  
                                <f:convertDateTime pattern="yyyy-MM-dd" />
                            </h:outputText>
                        </p:column>    
                        <p:column id="crby" headerText="By">                  
                            <h:outputText value="#{calibrec.performedBy}" />                              
                        </p:column>
                        <p:column id="crnotes" headerText="Notes" width="75%">                  
                            <h:outputText value="#{calibrec.notes}" />                              
                        </p:column>
                        <p:column id="crdet" headerText="Receipt" width="10%">                                            
                            <p:commandButton  icon="ui-icon-trash"  title="delete"  process="@this" 
                                              oncomplete="PF('delDiagWid').show()" 
                                              disabled="#{! authManager.authorized}"
                                              action="#{equipmentManager.setSelectedCR(calibrec)}">                              
                            </p:commandButton>                              
                            <p:button  icon="ui-icon-pencil"  title="edit" 
                                       outcome="calibration.xhtml?crid=#{calibrec.calibrationRecordId}" 
                                       target="_blank" disabled="true"/>
                            <p:button  icon="ui-icon-document" title="view" 
                                       outcome="calibration.xhtml?crid=#{calibrec.calibrationRecordId}" 
                                       target="_blank"/>
                        </p:column>
                        <f:facet name="footer">                              
                            <p:commandButton value="Add" icon="ui-icon-plus" ajax="false"
                                             action="#{equipmentManager.addCalibrationRecord(equipment)}"
                                             disabled="#{! authManager.authorized}"/> 
                            <p:commandButton value="Edit" icon="ui-icon-pencil" ajax="false"
                                             action="#{equipmentManager.addCalibrationRecord(equipment)}"
                                             disabled="#{! authManager.authorized}"  rendered="false"/>
                            <p:commandButton value="Delete" icon="ui-icon-trash" ajax="false"
                                             action="#{equipmentManager.addCalibrationRecord(equipment)}"
                                             disabled="#{! authManager.authorized}" rendered="false"/>
                        </f:facet>
                    </p:dataTable>
                    <p:dialog id="delDiag" widgetVar="delDiagWid">
                        <h:outputText value="Are you sure you want to deleted this record?" />
                        <p:commandButton value="Cancel" onclick="delDiagWid.hide()" type="button" />
                        <p:commandButton value="Delete" actionListener="#{equipmentManager.delCalibrationRecord}" 
                                         update="calibRecs :equipForm:equipMsgs" 
                                         process="@this"
                                         oncomplete="delDiagWid.hide()" />

                    </p:dialog>
                </p:rowExpansion>
                <f:facet name="footer">  
                    Total Records:  #{equipmentManager.equipments.size()}  
                </f:facet>
            </p:dataTable>
        </h:form>

    </ui:define>
</ui:composition>